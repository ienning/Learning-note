[TOC]

# 第一章Cuda介绍

Cuda能够高并行，低复杂的计算，一块GPU中包含成千上万个线程，GPU中有多个SM，一个SM包含一个control单元，一个cache，多个ALU计算单元。

Cuda接口一般有Cuda Runtime和Cuda Driver两种，最底层的是Cuda Driver，Cuda Runtime是封装了Cuda Driver的。它们是互斥的，一般只能选择一种使用，不可以同时使用。

GPU大致分为：

- 核函数
- 内存管理
- 线程管理
- 流

# 第二章Cuda，Kernel，Grid，block，thread

一个核函数对应一个grid，一个grid有多个block，一个block有多个thread，一般Grid是2维的block组成，而block是三维的thread组成的。

Kernel核函数编写有以下限制

1. 只能访问设备内存
2. 必须有void返回类型
3. 不支持可变数量的参数
4. 不支持静态变量
5. 显示异步行为

# 第三章Cuda执行模型

Cuda编程模型是Thread，Block，Grid这种观念，但是Cuda执行模型是实际的硬件，GPU的核心Core，然后多个Core组成一个SM，多个SM组成一个GPU设备。

**性能优化方向：**

- 应用程序代码的空间或时间复杂度
- 特殊指令的使用
- 函数调用的频率和持续时间

想要优化速度，性能分析工具要会用：

- nvvp
- nvprof

限制内核性能的主要包括但不限于以下因素

- 存储带宽
- 计算资源
- 指令和内存延迟

## SM（流式多处理器）

GPU每个SM都能支持数百个线程并发执行，每个GPU有多个SM，当一个核函数的网格被启动的时候，多个block会被同时分配到可用的SM上执行。

在SM上同一个块内的多个线程进行线程级别并行，而同一个线程内，指令利用指令级并行将单个线程处理成流水线。

注意：当一个block被分配给一个SM，他以后就只能在SM上执行了，不可能重新分配给其他SM上了，多个线程块可以分配到同一个SM上。

## 线程束

在硬件的微观上，CUDA 采用单指令多线程SIMT架构管理执行线程，不同设备有不同的线程束大小，但是到目前为止基本所有设备都是维持在32。**在某个时刻SM只执行一个线程束**，一个线程束中的每个线程都是同时同步执行同一条指令的，其中有些线程可以不选择执行，但是必须等待其它线程。在某个时刻SM只执行一个线程束。

SIMD是单指令多数据，要求其内的线程都执行，不能有停止的。但是SIMT允许某些线程选择不执行，但是要等到其它线程执行完。

当一个Block被分配到某个SM上，Block上的线程会被分为多个线程束，然后SM控制线程束交替进行。

### 线程束分化

在核函数中，如果有if，else的条件分支，那么线程束就碰到一个问题，因为线程束都是需要执行同一个执行的，那么如果有的满足if条件，有的满足else条件，那么就会导致线程束出现了矛盾是否选择满足自己条件的执行呢？其实可以选择都执行，但是碰到了不满足条件的，可以选择不执行指令，等待指令执行到自己需要的条件中去。

线程束分化研究的就是上面所说的问题，，研究一个线程束中的线程，不同线程束中的分支互不影响。

解决方法：

1. 可以将满足不同判断条件，分配到不同的线程束中，这样，线程束中满足一个条件就能执行了，不会影响性能

### 资源分配

一个SM上分配多少个线程块和线程束取决于SM中可用的寄存器和共享内存，以及内核需要的寄存器和共享内存大小。

每个SM上有多少个线程束处于激活状态取决于以下资源：

1. 程序计数器
2. 寄存器
3. 共享内存

当SM资源内没办法处理一个完整的块，那么程序可能无法启动。

当寄存器和共享内存分配给了线程块，这个线程块处于活跃状态，所包含的线程束称为活跃线程束。活跃线程束分为三类：

- 选定的线程束：指要执行某个线程束
- 阻塞的线程束：指不符合条件还没准备好的线程束
- 符合条件的线程束：准备好条件，等待执行的线程束。需要以下条件：
  - 32个Cuda核心可以用于执行
  - 执行所需要的资源全部到位

### 隐藏延迟

计算机算一个任务需要的时间

指令延迟：

- 算术延迟 10-20个时钟周期
- 内存延迟 400 - 800个时钟周期

线程束保证最小化延迟所需要的线程数

所需线程束 = 延迟 X 吞吐量

带宽一般指的是理论峰值，最大每个时钟周期能执行多少个指令，吞吐量是指实际操作过程中每分钟处理多少个指令
## 并行性表现

需要使用nsight compute和nsight system进行分析

- nsight compute偏向于核函数内部
- nsight system偏向于整体

## 避免分支化

在进行计算的时候，进行归约处理

## 循环展开
## 动态并行


